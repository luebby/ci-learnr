---
title: "Causal Inference"
output: 
  learnr::tutorial:
    progressive: true
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
library(ggdag)
coordLV <- list(
  x = c(sex = 0, age = 0, smoke = 1, height = 2, fev = 3),
  y = c(sex = 1, age = 2, smoke = 0, height = 2, fev = 0))
dagLV <- dagify(height ~ sex + age + smoke,
                smoke ~ sex + age,
                fev ~ height + sex + age + smoke,
                coords = coordLV,
                exposure = "smoke",
                outcome = "fev")
p1 <- ggdag(dagLV, text_col = "blue", node = FALSE, text_size = 5) + theme_dag_blank()


library(learnr)
library(tidyverse)
library(mosaic)

FEV <- read.table('http://jse.amstat.org/datasets/fev.dat.txt')
colnames(FEV) <- c("age", "fev", "height", "sex", "smoke")
FEV <- as.tibble(FEV)
FEV <- FEV %>%
  mutate(sex = ifelse(!sex, "female", "male")) %>%
  mutate(smoke = ifelse(!smoke, "no", "yes"))

checker <- function(label, user_code, check_code, envir_result, evaluate_result, ...) {
  list(message = check_code, correct = TRUE, location = "append")
}
tutorial_options(exercise.timelimit = 60, exercise.checker = checker)
```

## Preliminaries

This tutorial is based on [Causal Inference in Introductory Statistics Courses](https://github.com/kfcaby/causalLab) of [LTC Kevin Cummiskey](https://westpoint.edu/mathematical-sciences/profile/kevin_cummiskey), see Cummiskey, K., Adams, B,. Pleuss, J.,  Turner, D., Clark, N. \& Watts, K. (2020). *Causal Inference in Introductory Statistics Courses*, Journal of Statistics Education, [https://doi.org/10.1080/10691898.2020.1713936](https://doi.org/10.1080/10691898.2020.1713936).

Data is taken from Kahn, M. (2005). *An exhalent problem for teaching statistics*. Journal of Statistics Education, 13(2), [https://doi.org/10.1080/10691898.2005.11910559](https://doi.org/10.1080/10691898.2005.11910559).

<br>

*Note*: The R packages [mosaic](https://projectmosaic.github.io/mosaic/) with [ggformula](https://projectmosaic.github.io/ggformula/) are used for data analysis.

<br>

Please report any issues [here](https://github.com/luebby/ci-learnr/issues).

## Youth smoking

Nowadays we are sure that smoking is harmful. But this was not always clear and a naive data analysis may come to the opposite conclusion. 


In a series of papers (e.g. [Kahn, 2005](https://doi.org/10.1080/10691898.2005.11910559)) the question was analyzed if chidlhood smoking has an effect on  *forced expiratory volume*,  common measure of lung function.

###


```{r ethik, echo=FALSE}
question("Is it ethical here to conduct a randomized experiment?",
  answer("Yes.", message = "Negeative consequences of smoking can be expected."),
  answer("No.", correct = TRUE, message = "Negeative consequences of smoking can be expected.")
)
```


###

The data set `FEV` has the following structure:

```{r str}
str(FEV)
```

with variables

- `age`: the age of the subject in years
- `fev`: forced expiratory volume (L)
- `height`: the height of the subject in inches
- `sex`: biological sex of the subject
- `smoke`: whether the subject had ever smoked or no

```{r head}
head(FEV)
```


```{r skalennvieau, echo=FALSE}
question("Which measurement scale is `fev`?",
  answer("Nominal", message = "Values can be distinguished, ordered and differences as well as ratios are meaningful."),
  answer("Ordinal", message = "Values can be distinguished, ordered and differences as well as ratios are meaningful."), 
    answer("Interval", message = "Values can be distinguished, ordered and differences as well as ratios are meaningful."), 
    answer("Ratio", correct=TRUE, message = "Values can be distinguished, ordered and differences as well as ratios are meaningful.")
)
```

###

The following causal structure is assumed:

```{r p1, echo=FALSE}
p1
```

*Tip*: [DAGitty](http://dagitty.net/) and [ggdag](https://ggdag.netlify.app/) are nice tools for drawing and analyzing directed acyclic graphs.

## Smoking and forced expiratory volume

A boxplot of forced expiratory volume (`fev`) given smoking (`smoke`) gives the following result: 

```{r b1}
gf_boxplot(fev ~ smoke, data = FEV)
```

###

```{r median, echo=FALSE}
question("Which group has the higher median of `fev`?",
  answer("Non-smoker", message = "The median fev of non-smokers is $\\approx 2.5$ l, whereas for smokers it is $\\approx 3.2$  l."),
  answer("Smoker.", correct = TRUE, message = "The median fev of non-smokers is $\\approx 2.5$ l, whereas for smokers it is $\\approx 3.2$ l.")
)
```

###

Smoking and forced expiratory volume depend on sex.

Expand the code so that you can also condition on `sex`.

```{r bedingt, exercise = TRUE}
gf_boxplot(fev ~ smoke, data = FEV)
```

```{r bedingt-solution}
gf_boxplot(fev ~ smoke | sex, data = FEV)
```

###

The overall scene has not changed, smokers seem to have a higher forced expiratory volume.

###

Why?

## Age ...

Wie zu erwarten war, gibt es einen Zusammenhang zwischen age und Größe:

```{r }
gf_point(height ~ age, data = FEV) %>%
  gf_smooth()
```

###

Erweitern Sie den Code so, so dass Sie die Punkte gemäß der Variable `smoke` farbig markieren:

```{r color, exercise = TRUE}
gf_point(height ~ age, data = FEV) %>%
  gf_smooth()
```

```{r color-solution}
gf_point(height ~ age, color = ~ smoke, data = FEV) %>%
  gf_smooth()
```

###

Klar: Bei Heranwachsenden sind die Raucher\*innen älter als die Nichtraucher\*innen -- und damit auch größer.

###

Und natürlich gibt es auch einen Zusammenhang zwischen der Größe und dem fev:

```{r}
gf_point(fev ~ height, data = FEV) %>%
  gf_smooth()
```

## Kausale Modellierung Rauchen und fev 

Hier noch einmal das angenommene Modell:

```{r p12, echo = FALSE}
p1
```



Eine naive Modellierung ergibt folgendes Ergebnis:

```{r}
lm(fev ~ smoke, data = FEV) %>%
  summary()
```

### 

Rauchen *scheint* das fev zu erhöhen.

Warum?

###

Weil die nicht-kausalen Pfade durch die *Hintertür* (engl. backdoor, *Fork*) offen sind:

$$\text{smoke} \leftarrow \text{sex} \rightarrow \text{fev}$$
bzw.

$$\text{smoke} \leftarrow \text{age} \rightarrow \text{fev}$$
Diese Pfade sollten also z.B. durch Adjustierung *blockiert* werden.


```{r chain, echo=FALSE}
question("Sollte über die Variable `height` adjustiert werden?",
  answer("Ja.", message = "Falsch: die Variable `height` liegt auf dem kausalen Pfad (*Chain*) zwischen `smoke` und `fev` (Mediator)"),
  answer("Nein.", correct = TRUE, message = "Richtig: die Variable `height` liegt auf dem kausalen Pfad (*Chain*) zwischen `smoke` und `fev` (Mediator).")
)
```

###

Geben Sie, unter der Annahme eines linearen Modells die Formel an, die den (totalen) kausalen Effekt des Rauchens auf das fev schätzt:

```{r model, exercise = TRUE, eval=FALSE}
lm(fev ~ smoke + ___ + ___, data = FEV) %>%
  summary()
```

```{r model-solution}
lm(fev ~ smoke + sex + age, data = FEV) %>%
  summary()
```

###

```{r effekt, echo=FALSE}
question("Hat in dem Modell Rauchen einen negativen Effekt auf das fev?",
  answer("Ja.", correct = TRUE, message = "Richtig: der geschätzte Koeffizient ist mit $-0.153974$ negativ (`Estimate` für die Variable `smokeja `)."),
  answer("Nein.", message = "Falsch: der geschätzte Koeffizient ist mit $-0.153974$ negativ (`Estimate` für die Variable `smokeja `).")
)
```

###

```{r pwert, echo=FALSE}
question("Wäre der geschätzte Effekt von ($\\hat{\\beta}_{\\text{smokeja}}=-0.153974$) plausibel, wenn es gar keinen geben würde ($H_0: {\\beta}_{\\text{smokeja}}=0$)?",
  answer("Ja.", message = "Falsch: nicht besonders: die Wahrscheinlichkeit in dem Modell ${\\beta}_{\\text{smokeja}}=0$ einen mindestens so großen Wert wie $\\hat{\\beta}_{\\text{smokeja}}=-0.153974$ in einer Stichprobe zu beobachten liegt bei 0.0487 (p-Wert, siehe `Pr(>|t|)`."),
  answer("Nein.", correct = TRUE, message = "Richtig: die Wahrscheinlichkeit in dem Modell ${\\beta}_{\\text{smokeja}}=0$ einen mindestens so großen Wert wie $\\hat{\\beta}_{\\text{smokeja}}=-0.153974$ in einer Stichprobe zu beobachten liegt bei 0.0487 (p-Wert, siehe `Pr(>|t|)`.")
)
```

*Hinweis*: Die Annahme eines linearen Modells ist aufgrund des nicht-linearen Zusammenhangs zwischen age und Größe sowie Größe und fev (siehe Abbildungen im Abschnitt *Das age ...*) eher nur eine Näherung.

## Ausblick

Die Kausale Inferenz bietet viele weitere und fortgeschrittene Möglichkeiten der Analyse. Siehe z.B. als Einstieg: Pearl, J., Glymour, M., \& Jewell, N. P. (2016). *Causal inference in statistics: A primer*. John Wiley \& Sons, [http://bayes.cs.ucla.edu/PRIMER/](http://bayes.cs.ucla.edu/PRIMER/).