---
title: "Causal Inference"
output: 
  learnr::tutorial:
    progressive: true
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
library(ggdag)
coordLV <- list(
  x = c(sex = 0, age = 0, smoke = 1, height = 2, fev = 3),
  y = c(sex = 1, age = 2, smoke = 0, height = 2, fev = 0))
dagLV <- dagify(height ~ sex + age + smoke,
                smoke ~ sex + age,
                fev ~ height + sex + age + smoke,
                coords = coordLV,
                exposure = "smoke",
                outcome = "fev")
p1 <- ggdag(dagLV, text_col = "blue", node = FALSE, text_size = 5) + theme_dag_blank()


library(learnr)
library(tidyverse)
library(mosaic)

FEV <- read.table('http://jse.amstat.org/datasets/fev.dat.txt')
colnames(FEV) <- c("age", "fev", "height", "sex", "smoke")
FEV <- as_tibble(FEV)
FEV <- FEV %>%
  mutate(sex = ifelse(!sex, "female", "male")) %>%
  mutate(smoke = ifelse(!smoke, "no", "yes"))

checker <- function(label, user_code, check_code, envir_result, evaluate_result, ...) {
  list(message = check_code, correct = TRUE, location = "append")
}
tutorial_options(exercise.timelimit = 60, exercise.checker = checker)
```

## Preliminaries

This tutorial is based on [Causal Inference in Introductory Statistics Courses](https://github.com/kfcaby/causalLab) of [LTC Kevin Cummiskey](https://westpoint.edu/mathematical-sciences/profile/kevin_cummiskey), see Cummiskey, K., Adams, B,. Pleuss, J.,  Turner, D., Clark, N. \& Watts, K. (2020). *Causal Inference in Introductory Statistics Courses*, Journal of Statistics Education, [https://doi.org/10.1080/10691898.2020.1713936](https://doi.org/10.1080/10691898.2020.1713936).

Data is taken from Kahn, M. (2005). *An exhalent problem for teaching statistics*. Journal of Statistics Education, 13(2), [https://doi.org/10.1080/10691898.2005.11910559](https://doi.org/10.1080/10691898.2005.11910559).

<br>

*Note*: The R packages [mosaic](https://projectmosaic.github.io/mosaic/) with [ggformula](https://projectmosaic.github.io/ggformula/) are used for data analysis.

<br>

Please report any issues [here](https://github.com/luebby/ci-learnr/issues).

## Youth smoking

Nowadays we are sure that smoking is harmful. But this was not always clear and a naive data analysis may come to the opposite conclusion. 


In a series of papers (e.g. [Kahn, 2005](https://doi.org/10.1080/10691898.2005.11910559)) the question was analyzed if chidlhood smoking has an effect on  *forced expiratory volume*,  common measure of lung function.

###


```{r ethik, echo=FALSE}
question("Is it ethical here to conduct a randomized experiment?",
  answer("Yes.", message = "Negeative consequences of smoking can be expected."),
  answer("No.", correct = TRUE, message = "Negeative consequences of smoking can be expected.")
)
```


###

The data set `FEV` has the following structure:

```{r str}
str(FEV)
```

with variables

- `age`: the age of the subject in years
- `fev`: forced expiratory volume (L)
- `height`: the height of the subject in inches
- `sex`: biological sex of the subject
- `smoke`: whether the subject had ever smoked or no

```{r head}
head(FEV)
```


```{r skalennvieau, echo=FALSE}
question("What is the measurement scale of `fev`?",
  answer("Nominal", message = "Values can be distinguished, ordered and differences as well as ratios are meaningful."),
  answer("Ordinal", message = "Values can be distinguished, ordered and differences as well as ratios are meaningful."), 
    answer("Interval", message = "Values can be distinguished, ordered and differences as well as ratios are meaningful."), 
    answer("Ratio", correct=TRUE, message = "Values can be distinguished, ordered and differences as well as ratios are meaningful.")
)
```

###

The following causal structure is assumed:

```{r p1, echo=FALSE}
p1
```

*Tip*: [DAGitty](http://dagitty.net/) and [ggdag](https://ggdag.netlify.app/) are nice tools for drawing and analyzing directed acyclic graphs.

## Smoking and forced expiratory volume

A boxplot of forced expiratory volume (`fev`) given smoking (`smoke`) gives the following result: 

```{r b1}
gf_boxplot(fev ~ smoke, data = FEV)
```

###

```{r median, echo=FALSE}
question("Which group has the higher median of `fev`?",
  answer("Non-smoker", message = "The median fev of non-smokers is $\\approx 2.5$ l, whereas for smokers it is $\\approx 3.2$  l."),
  answer("Smoker.", correct = TRUE, message = "The median fev of non-smokers is $\\approx 2.5$ l, whereas for smokers it is $\\approx 3.2$ l.")
)
```

###

Smoking and forced expiratory volume depend on sex.

Expand the code so that you can also condition on `sex`.

```{r bedingt, exercise = TRUE}
gf_boxplot(fev ~ smoke, data = FEV)
```

```{r bedingt-solution}
gf_boxplot(fev ~ smoke | sex, data = FEV)
```

###

The overall scene has not changed, smokers seem to have a higher forced expiratory volume.

###

Why?

## Age ...

Thinking about the data: height is associated with age:

```{r }
gf_point(height ~ age, data = FEV) %>%
  gf_smooth()
```

###

Expand the code to color the points by `smoke`:

```{r color, exercise = TRUE}
gf_point(height ~ age, data = FEV) %>%
  gf_smooth()
```

```{r color-solution}
gf_point(height ~ age, color = ~ smoke, data = FEV) %>%
  gf_smooth()
```

###

In childhood smoking: those who smoke are older than than those who don't -- and also taller.

###

And of course there is an association between height and forced expiratory volume.

```{r}
gf_point(fev ~ height, data = FEV) %>%
  gf_smooth()
```

## Causal inference 

The assumed causal model of the data generating process is:

```{r p12, echo = FALSE}
p1
```



A naive modeling of forced expiratory volume by smoking gives the following result:

```{r}
lm(fev ~ smoke, data = FEV) %>%
  summary()
```

### 

Smoking seems to increase the forced expiratory volume ...

Why?

###

Because the non-causal *backdoor* path are open:

$$\text{smoke} \leftarrow \text{sex} \rightarrow \text{fev}$$

and

$$\text{smoke} \leftarrow \text{age} \rightarrow \text{fev}$$

Here age is in the middle of af a *fork*.

These paths should be blocked by means of e.g. adjusting.

```{r chain, echo=FALSE}
question("Should we adjust also `height`?",
  answer("Yes.", message = "`height` is on the causal path between `smoke` and `fev` (Mediator in a *chain*)."),
  answer("No.", correct = TRUE, message = "`height` is on the causal path between `smoke` and `fev` (Mediator in a *chain*).")
)
```

###

Give a formula which would allow to estimate the total causal effect of smoking on forced expiratory volume under the assumption that a parametric linear model applies: 

```{r model, exercise = TRUE, eval=FALSE}
lm(fev ~ smoke + ___ + ___, data = FEV) %>%
  summary()
```

```{r model-solution}
lm(fev ~ smoke + sex + age, data = FEV) %>%
  summary()
```

###

```{r effekt, echo=FALSE}
question("Has smoking a negative total causal effect on the forced expiratory volume?",
  answer("Ja.", correct = TRUE, message = "The estimated coefficient is negative: $-0.153974$ (`Estimate` for `smokeyes`)."),
  answer("Nein.", message = "The estimated coefficient is negative: $-0.153974$ (`Estimate` for `smokeyes`).")
)
```

###

```{r pwert, echo=FALSE}
question("Is the estimate ($\\hat{\\beta}_{\\text{smokeyes}}=-0.153974$) compatible to the model if no effect($H_0: {\\beta}_{\\text{smokeyes}}=0$)?",
  answer("Yes.", message = "The probability in a model with ${\\beta}_{\\text{smokeyes}}=0$ to get a sample with an estimate as least as large as $\\hat{\\beta}_{\\text{smokeyes}}=|-0.153974|$ is $0.0487$ (p-value`Pr(>|t|)`."),
  answer("No.", correct = TRUE, message = "The probability in a model with ${\\beta}_{\\text{smokeyes}}=0$ to get a sample with an estimate as least as large as $\\hat{\\beta}_{\\text{smokeyes}}=|-0.153974|$ is $0.0487$ (p-value`Pr(>|t|)`.")
)
```

*Note*: The assumption of a linear model is due to the non-linear association between age and height as well as height and forced expiratory volume a questionable approximation.

### Simulation based inference

That the observed effect in the data is uncommon if the forced expiratory volume is independent of smoking can also be seen by a permutation test. Simulation based inference, i.e. simulating the distribution of $\hat{\beta}_{\text{smokeyes}}$ while shuffling smoke:

```{r permute, warning=FALSE , exercise = TRUE}
set.seed(1896)

Nulldist <- do(1000) * lm(fev ~ shuffle(smoke) + sex + age, data = FEV)

gf_histogram( ~ smokeyes, data = Nulldist, center = 0, bins = 21) %>%
  gf_vline(xintercept = -0.153974)
```


## Summary

As Kari Lock Morgan puts it [here](https://askgoodquestions.blog/2020/07/27/56-questioning-causal-evidence/):

> Two key questions [we] should ask and answer when evaluating causal evidence:

>  - Do we have convincing evidence against "just random chance"?  Why or why not?

>  - Do we have convincing evidence against the groups differing to being with?  Why or why not?

For the date in this tutorial the smoking and non-smoking group differ by e.g. age. Therefor the naive comparison was flawed.

The rather low p-value in the parametric hypothesis test of ${\beta}_{\text{smokeyes}}=0$ gives as (weak) evidence against just random chance. 

<br>

**Citation**: Karsten Lübke, Matthias Gehrke, Jörg Horst \& Gero Szepannek (2020) Why We Should Teach Causal Inference: Examples in Linear Regression With Simulated Data, Journal of Statistics Education, 28:2, 133-139, [https://doi.org/10.1080/10691898.2020.1752859](https://doi.org/10.1080/10691898.2020.1752859).

<br>

**Literature** e.g.: Pearl, J., Glymour, M., \& Jewell, N. P. (2016). *Causal inference in statistics: A primer*. John Wiley \& Sons, [http://bayes.cs.ucla.edu/PRIMER/](http://bayes.cs.ucla.edu/PRIMER/).


